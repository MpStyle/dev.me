(function(b){var a=function(d){var c=this;var e=function(){};this.options=b.extend({ajaxUrl:null,headers:{},socketUrl:null,onmessage:e,onopen:e,onclose:e,onerror:e,getSocket:function(f){return c._getSocket(f)}},d);this.wsOnMessage=function(f){c._wsOnMessage(f)};this._ws_request_queue=[];if(!window.JSON&&b&&b.toJSON){this.JSON={stringify:b.toJSON,parse:b.parseJSON}}else{this.JSON=JSON}};a.prototype._ws_socket=null;a.prototype._ws_callbacks={};a.prototype._current_id=1;a.prototype.call=function(j,i,d,h){d=typeof d==="function"?d:function(){};h=typeof h==="function"?h:function(){};var g={jsonrpc:"2.0",method:j,params:i,id:this._current_id++};var c=this.options.getSocket(this.wsOnMessage);if(c!==null){this._wsCall(c,g,d,h);return null}if(this.options.ajaxUrl===null){throw"JsonRpcClient.call used with no websocket and no http endpoint."}var f=this;var e=b.ajax({type:"POST",url:this.options.ajaxUrl,contentType:"application/json",data:this.JSON.stringify(g),dataType:"json",cache:false,headers:this.options.headers,success:function(k){if("error" in k){h(k.error)}else{d(k.result)}},error:function(m,o,n){try{var k=f.JSON.parse(m.responseText);7;if("console" in window){console.log(k)}h(k.error)}catch(l){h({error:m.responseText})}}});return e};a.prototype.notify=function(g,f){var e={jsonrpc:"2.0",method:g,params:f};var c=this.options.getSocket(this.wsOnMessage);if(c!==null){this._wsCall(c,e);return null}if(this.options.ajaxUrl===null){throw"JsonRpcClient.notify used with no websocket and no http endpoint."}var d=b.ajax({type:"POST",url:this.options.ajaxUrl,contentType:"application/json",data:this.JSON.stringify(e),dataType:"json",cache:false,headers:this.options.headers});return d};a.prototype.batch=function(f,c,e){var d=new a._batchObject(this,c,e);f(d);d._execute()};a.prototype._getSocket=function(c){if(this.options.socketUrl===null||!("WebSocket" in window)){return null}if(this._ws_socket===null||this._ws_socket.readyState>1){this._ws_socket=new WebSocket(this.options.socketUrl);this._ws_socket.onmessage=c;this._ws_socket.onclose=this.options.onclose;this._ws_socket.onerror=this.options.onerror}return this._ws_socket};a.prototype._wsCall=function(d,h,c,g){var f=this.JSON.stringify(h);if(d.readyState<1){this._ws_request_queue.push(f);if(!d.onopen){var e=this;d.onopen=function(k){e.options.onopen(k);for(var j=0;j<e._ws_request_queue.length;j++){d.send(e._ws_request_queue[j])}e._ws_request_queue=[]}}}else{d.send(f)}if("id" in h&&typeof c!=="undefined"){this._ws_callbacks[h.id]={success_cb:c,error_cb:g}}};a.prototype._wsOnMessage=function(g){var d;try{d=this.JSON.parse(g.data)}catch(f){this.options.onmessage(g);return}if(typeof d==="object"&&d.jsonrpc==="2.0"){if("result" in d&&this._ws_callbacks[d.id]){var c=this._ws_callbacks[d.id].success_cb;delete this._ws_callbacks[d.id];c(d.result);return}else{if("error" in d&&this._ws_callbacks[d.id]){var e=this._ws_callbacks[d.id].error_cb;delete this._ws_callbacks[d.id];e(d.error);return}}}this.options.onmessage(g)};a._batchObject=function(d,c,e){this._requests=[];this.jsonrpcclient=d;this.all_done_cb=c;this.error_cb=typeof e==="function"?e:function(){}};a._batchObject.prototype.call=function(f,e,c,d){this._requests.push({request:{jsonrpc:"2.0",method:f,params:e,id:this.jsonrpcclient._current_id++},success_cb:c,error_cb:d})};a._batchObject.prototype.notify=function(d,c){this._requests.push({request:{jsonrpc:"2.0",method:d,params:c}})};a._batchObject.prototype._execute=function(){var l=this;var m=null;if(this._requests.length===0){return}var k=[];var j=l.jsonrpcclient.options.getSocket(l.jsonrpcclient.wsOnMessage);if(j!==null){var e=0;var f=[];var h=function(i){if(!l.all_done_cb){return i}return function(r){i(r);f.push(r);e--;if(e<=0){var q;var o={};for(q=0;q<f.length;q++){o[f[q].id]=f[q]}var p=[];for(q=0;q<l._requests.length;q++){if(o[l._requests[q].id]){p.push(o[l._requests[q].id])}}l.all_done_cb(p)}}};for(var d=0;d<this._requests.length;d++){var n=this._requests[d];if("id" in n.request){e++}l.jsonrpcclient._wsCall(j,n.request,h(n.success_cb),h(n.error_cb))}return null}else{var c={};for(var d=0;d<this._requests.length;d++){var n=this._requests[d];k.push(n.request);if("id" in n.request){c[n.request.id]={success_cb:n.success_cb,error_cb:n.error_cb}}}var g=function(i){l._batchCb(i,c,l.all_done_cb)};if(l.jsonrpcclient.options.ajaxUrl===null){throw"JsonRpcClient.batch used with no websocket and no http endpoint."}m=b.ajax({url:l.jsonrpcclient.options.ajaxUrl,contentType:"application/json",data:this.jsonrpcclient.JSON.stringify(k),dataType:"json",cache:false,type:"POST",headers:l.jsonrpcclient.options.headers,error:function(i,p,o){l.error_cb(i,p,o)},success:g});return m}};a._batchObject.prototype._batchCb=function(c,f,e){for(var g=0;g<c.length;g++){var d=c[g];if("error" in d){if(d.id===null||!(d.id in f)){if("console" in window){console.log(d)}}else{f[d.id].error_cb(d.error)}}else{if(!(d.id in f)&&"console" in window){console.log(d)}else{f[d.id].success_cb(d.result)}}}if(typeof e==="function"){e(c)}};b.JsonRpcClient=a})(this.jQuery);